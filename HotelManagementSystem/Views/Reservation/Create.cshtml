@model DTOs.CreateReservationDto

@{
    ViewData["Title"] = "Book Room";
    var room = ViewBag.Room as DTOs.RoomDto;
}

<div class="container mt-4">
<h1>Book Room @room?.RoomNumber</h1>
<hr />

<div class="row">
    <div class="col-lg-8 col-md-7">
        <div class="card mb-4">
            <div class="card-header">
                <h5>Reservation Details</h5>
            </div>
            <div class="card-body">
                <form asp-action="Create" method="post">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
                        
                    <input type="hidden" asp-for="RoomId" />

                    <div class="row">
                        <div class="col-6 mb-3">
                            <label asp-for="CheckInDate" class="form-label">Check-in Date</label>
                            <div class="input-group">
                                <input type="text" asp-for="CheckInDate" class="form-control datepicker" 
                                       id="checkInDatePicker"
                                       placeholder="dd-MM-yyyy" 
                                       pattern="\d{2}-\d{2}-\d{4}"
                                       value="@DateTime.Now.ToString("dd-MM-yyyy")" required readonly />
                                <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                            </div>
                            <span asp-validation-for="CheckInDate" class="text-danger"></span>
                        </div>
                        <div class="col-6 mb-3">
                            <label asp-for="CheckOutDate" class="form-label">Check-out Date</label>
                            <div class="input-group">
                                <input type="text" asp-for="CheckOutDate" class="form-control datepicker" 
                                       id="checkOutDatePicker"
                                       placeholder="dd-MM-yyyy" 
                                       pattern="\d{2}-\d{2}-\d{4}"
                                       value="@DateTime.Now.AddDays(1).ToString("dd-MM-yyyy")" required readonly />
                                <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                            </div>
                            <span asp-validation-for="CheckOutDate" class="text-danger"></span>
                        </div>
                    </div>

                    <hr />
                    <h6>Guest Information</h6>

                    <div class="mb-3">
                        <label asp-for="FullName" class="form-label">Full Name</label>
                        <input type="text" asp-for="FullName" class="form-control" required />
                        <span asp-validation-for="FullName" class="text-danger"></span>
                    </div>

                    <div class="row">
                        <div class="col-6 mb-3">
                            <label asp-for="Email" class="form-label">Email</label>
                            <input type="email" asp-for="Email" class="form-control" value="" />
                            <span asp-validation-for="Email" class="text-danger"></span>
                        </div>
                        <div class="col-6 mb-3">
                            <label asp-for="Phone" class="form-label">Phone</label>
                            <input type="tel" asp-for="Phone" class="form-control" required />
                            <span asp-validation-for="Phone" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-6 mb-3">
                            <label asp-for="IdentityNumber" class="form-label">Identity Number</label>
                            <input type="text" asp-for="IdentityNumber" class="form-control" required />
                            <span asp-validation-for="IdentityNumber" class="text-danger"></span>
                        </div>
                        <div class="col-6 mb-3">
                            <label asp-for="Address" class="form-label">Address</label>
                            <input type="text" asp-for="Address" class="form-control" required />
                            <span asp-validation-for="Address" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                        <a asp-controller="Home" asp-action="Index" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary">Confirm Reservation</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4 col-md-5">
        <!-- Room Details -->
        <div class="card mb-3">
            <div class="card-header">
                <h5>Room Details</h5>
            </div>
            <div class="card-body py-2">
                <div class="row">
                    <div class="col-6">
                        <small class="text-muted">Room Type</small>
                        <p class="mb-1"><strong>@room?.RoomType</strong></p>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Room Number</small>
                        <p class="mb-1"><strong>@room?.RoomNumber</strong></p>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Capacity</small>
                        <p class="mb-1"><strong>@room?.Capacity person(s)</strong></p>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Price</small>
                        <p class="mb-1"><strong>@room?.Price.ToString("N0") &#8363;/night</strong></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Availability Calendar -->
        <div class="card mb-3">
            <div class="card-header">
                <h5><i class="bi bi-calendar3"></i> Availability</h5>
            </div>
            <div class="card-body text-center">
                <div id="availabilityCalendar" class="d-flex justify-content-center"></div>
                <div class="mt-3 small">
                    <span class="badge bg-success me-1">Available</span>
                    <span class="badge bg-danger me-1">Booked</span>
                    <span class="badge bg-warning text-dark">Maintenance</span>
                </div>
            </div>
        </div>

        <!-- Booking Summary -->
        <div class="card">
            <div class="card-header">
                <h5>Booking Summary</h5>
            </div>
            <div class="card-body py-2">
                <p class="text-muted small mb-0" id="summaryPlaceholder">Select dates to see total price</p>
                <div id="bookingSummary" style="display: none;">
                    <div class="d-flex justify-content-between">
                        <span>Number of Nights:</span>
                        <strong><span id="nights">0</span></strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Price per Night:</span>
                        <strong>@room?.Price.ToString("N0") &#8363;</strong>
                    </div>
                    <hr class="my-2" />
                    <div class="d-flex justify-content-between">
                        <span class="fw-bold">Total Price:</span>
                        <span class="fw-bold text-success"><span id="totalPrice">0</span> &#8363;</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
    <style>
        /* Calendar styling */
        #availabilityCalendar {
            font-family: inherit;
            display: flex;
            justify-content: center;
        }
        #availabilityCalendar .flatpickr-day.unavailable {
            background-color: #dc3545 !important;
            color: white !important;
            cursor: not-allowed !important;
            pointer-events: none;
        }
        #availabilityCalendar .flatpickr-day.flatpickr-disabled {
            background-color: #6c757d !important;
            color: white !important;
        }
        #availabilityCalendar .flatpickr-day:not(.flatpickr-disabled):not(.unavailable):hover {
            background-color: #198754;
            color: white;
        }
        .flatpickr-day.unavailable,
        .flatpickr-day.unavailable:hover {
            background-color: #dc3545 !important;
            color: white !important;
            cursor: not-allowed !important;
        }
        /* Style for the inline calendar */
        #availabilityCalendar .flatpickr-calendar {
            box-shadow: none;
            border: 1px solid #dee2e6;

        }
        #availabilityCalendar .flatpickr-months {
            padding: 10px 0;
        }
        #availabilityCalendar .flatpickr-current-month {
            font-size: 1.1rem;
        }

        #availabilityCalendar .flatpickr-wrapper {
            width: fit-content;
        }
    </style>
    
    <script>
        const pricePerNight = @room?.Price ?? 0;
        const roomId = @room?.Id ?? 0;
        const checkInInput = document.querySelector('input[name="CheckInDate"]');
        const checkOutInput = document.querySelector('input[name="CheckOutDate"]');
        
        let unavailableDates = [];
        let checkInPicker, checkOutPicker, calendarInstance;

        // Fetch unavailable dates from server
        async function fetchUnavailableDates() {
            try {
                const response = await fetch(`/Reservation/GetUnavailableDates?roomId=${roomId}`);
                unavailableDates = await response.json();
                initializeCalendars();
            } catch (error) {
                console.error('Error fetching unavailable dates:', error);
                initializeCalendars();
            }
        }

        function isDateUnavailable(date) {
            const dateStr = date.toISOString().split('T')[0];
            return unavailableDates.includes(dateStr);
        }

        function initializeCalendars() {
            // Initialize the availability calendar (inline display)
            calendarInstance = flatpickr("#availabilityCalendar", {
                inline: true,
                mode: "range",
                dateFormat: "Y-m-d",
                minDate: "today",
                showMonths: 1,
                disable: [
                    function(date) {
                        return isDateUnavailable(date);
                    }
                ],
                onDayCreate: function(dObj, dStr, fp, dayElem) {
                    const date = dayElem.dateObj;
                    if (isDateUnavailable(date)) {
                        dayElem.classList.add('unavailable');
                        dayElem.title = 'This date is not available';
                    }
                },
                onChange: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length === 2) {
                        // Check if range contains unavailable dates
                        const start = selectedDates[0];
                        const end = selectedDates[1];
                        let hasUnavailable = false;
                        
                        for (let d = new Date(start); d < end; d.setDate(d.getDate() + 1)) {
                            if (isDateUnavailable(new Date(d))) {
                                hasUnavailable = true;
                                break;
                            }
                        }
                        
                        if (hasUnavailable) {
                            alert('Your selected date range includes unavailable dates. Please select different dates.');
                            instance.clear();
                            return;
                        }
                        
                        // Update the form date pickers
                        checkInPicker.setDate(start);
                        checkOutPicker.setDate(end);
                        calculateTotal();
                    }
                }
            });

            // Initialize Flatpickr for Check-in Date
            checkInPicker = flatpickr("#checkInDatePicker", {
                dateFormat: "d-m-Y",
                minDate: "today",
                defaultDate: new Date(),
                disable: [
                    function(date) {
                        return isDateUnavailable(date);
                    }
                ],
                onDayCreate: function(dObj, dStr, fp, dayElem) {
                    if (isDateUnavailable(dayElem.dateObj)) {
                        dayElem.classList.add('unavailable');
                    }
                },
                onChange: function(selectedDates, dateStr, instance) {
                    // Update check-out minimum date
                    checkOutPicker.set('minDate', new Date(selectedDates[0].getTime() + 86400000));
                    calendarInstance.setDate([selectedDates[0], checkOutPicker.selectedDates[0]]);
                    calculateTotal();
                }
            });

            // Initialize Flatpickr for Check-out Date
            checkOutPicker = flatpickr("#checkOutDatePicker", {
                dateFormat: "d-m-Y",
                minDate: new Date(new Date().getTime() + 86400000),
                defaultDate: new Date(new Date().getTime() + 86400000),
                disable: [
                    function(date) {
                        return isDateUnavailable(date);
                    }
                ],
                onDayCreate: function(dObj, dStr, fp, dayElem) {
                    if (isDateUnavailable(dayElem.dateObj)) {
                        dayElem.classList.add('unavailable');
                    }
                },
                onChange: function(selectedDates, dateStr, instance) {
                    calendarInstance.setDate([checkInPicker.selectedDates[0], selectedDates[0]]);
                    calculateTotal();
                }
            });
        }

        // Convert dd-MM-yyyy to Date object
        function parseDate(dateString) {
            if (!dateString) return null;
            const parts = dateString.split('-');
            if (parts.length !== 3) return null;
            // parts[0] = day, parts[1] = month, parts[2] = year
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }

        function calculateTotal() {
            const checkIn = parseDate(checkInInput.value);
            const checkOut = parseDate(checkOutInput.value);

            if (checkIn && checkOut && checkOut > checkIn) {
                const timeDiff = checkOut.getTime() - checkIn.getTime();
                const nights = Math.ceil(timeDiff / (1000 * 3600 * 24));
                const total = nights * pricePerNight;

                document.getElementById('nights').textContent = nights;
                document.getElementById('totalPrice').textContent = Math.round(total).toLocaleString('vi-VN');
                document.getElementById('summaryPlaceholder').style.display = 'none';
                document.getElementById('bookingSummary').style.display = 'block';
            } else {
                document.getElementById('summaryPlaceholder').style.display = 'block';
                document.getElementById('bookingSummary').style.display = 'none';
            }
        }

        // Fetch unavailable dates and initialize on page load
        fetchUnavailableDates();
    </script>
}
