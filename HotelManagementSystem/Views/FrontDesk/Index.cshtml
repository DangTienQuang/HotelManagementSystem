@model HotelManagementSystem.Models.FrontDeskViewModel
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong>Error:</strong> @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@{
    ViewData["Title"] = "Hotel Check-in / Check-out";
}

<style>
    /* ... (Keep your existing CSS exactly as it was) ... */
    /* Desktop-like Layout */
    .desktop-wrapper {
        display: flex;
        gap: 20px;
        padding: 20px;
        background-color: #f8f9fa;
        height: 85vh;
    }

    .list-panel {
        flex: 1;
        background: white;
        border: 1px solid #ccc;
        display: flex;
        flex-direction: column;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
    }

    .list-header {
        background-color: #e9ecef;
        padding: 10px;
        font-weight: bold;
        border-bottom: 1px solid #ccc;
    }

    .table-container {
        flex-grow: 1;
        overflow-y: auto;
    }

    .table-desktop {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }

        .table-desktop th {
            background-color: #f0f0f0;
            position: sticky;
            top: 0;
            border-bottom: 1px solid #aaa;
            padding: 8px;
            text-align: left;
        }

        .table-desktop td {
            border-bottom: 1px solid #eee;
            padding: 6px 8px;
            cursor: pointer;
        }

    .selected-row {
        background-color: #0d6efd !important;
        color: white;
    }

    .action-panel {
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 15px;
        width: 120px;
    }

    .btn-action {
        width: 100%;
        padding: 10px;
        border: 1px solid #999;
        background-color: #e0e0e0;
        font-weight: bold;
        color: black;
        cursor: pointer;
        transition: background 0.2s;
    }

        .btn-action:hover:not(:disabled) {
            background-color: #d0d0d0;
        }

        .btn-action:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
</style>

<h2 class="text-center">Hotel Check-in / Check-out</h2>

<div class="desktop-wrapper">

    <div class="list-panel">
        <div class="list-header">Upcoming Reservations</div>
        <div class="table-container">
            <table class="table-desktop" id="tableArrivals">
                <thead>
                    <tr>
                        <th style="width: 50px;">ID</th>
                        <th>Mã Khách</th>
                        <th>Reserve</th>
                        <th>Check-in</th>
                        <th>Check-out</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.Arrivals)
                    {
                        <tr onclick="selectArrival(this, @item.Id)">
                            <td>@item.Id</td>
                            <td>@item.CustomerId</td>
                            <td>@(item.Room?.RoomNumber ?? "None")</td>
                            <td>@(item.CheckInDate.HasValue? item.CheckInDate.Value.ToString("yyyy-MM-dd") : "-")</td>
                            <td>@(item.CheckOutDate.HasValue? item.CheckOutDate.Value.ToString("yyyy-MM-dd") : "-")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <div class="action-panel">
        <form id="formCheckIn" asp-action="CheckIn" method="post">
            <input type="hidden" name="id" id="valCheckInId" />
        </form>

        <button id="btnCheckIn" class="btn-action" onclick="doCheckIn()" disabled>Check-in</button>
        <button id="btnCheckOut" class="btn-action" onclick="doCheckOut()" disabled>Check-out</button>
        <button class="btn-action" onclick="window.location.reload()">Refresh</button>
        <a asp-controller="StaffDashboard" asp-action="Index" class="btn btn-action text-decoration-none text-center" style="display:block; padding-top:10px;">Exit</a>
    </div>

    <div class="list-panel">
        <div class="list-header">Currently Checked-in Guests</div>
        <div class="table-container">
            <table class="table-desktop" id="tableInHouse">
                <thead>
                    <tr>
                        <th style="width: 50px;">ID</th>
                        <th>Mã Book</th>
                        <th>Mã Staff (In)</th>
                        <th>Giờ Check-in</th>
                        <th>Giờ Check-out</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.InHouse)
                    {
                        var activeCheckIn = item.CheckInOuts.FirstOrDefault(c => c.CheckOutTime == null);

                        <tr onclick="selectInHouse(this, @item.Id)">
                            <td>@item.Id</td>
                            <td>@item.Id</td>
                            <td>@(activeCheckIn?.CheckInBy?.ToString() ?? "-")</td>
                            <td>@(activeCheckIn?.CheckInTime?.ToString("yyyy-MM-dd HH:mm") ?? "-")</td>
                            <td>@(item.CheckOutDate.HasValue? item.CheckOutDate.Value.ToString("yyyy-MM-dd") : "-")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    let selectedArrivalId = null;
    let selectedInHouseId = null;

    // --- ARRIVAL SELECTION ---
    function selectArrival(row, id) {
        console.log("Selected Arrival ID:", id); // Check Console for this

        // 1. Remove blue color from all rows
        document.querySelectorAll('#tableArrivals tr').forEach(r => r.classList.remove('selected-row'));

        // 2. Add blue color to clicked row
        row.classList.add('selected-row');

        // 3. Enable button
        selectedArrivalId = id;
        document.getElementById('btnCheckIn').disabled = false;

        // 4. Deselect the other table
        resetRightSide();
    }

    // --- IN-HOUSE SELECTION ---
    function selectInHouse(row, id) {
        console.log("Selected In-House ID:", id); // Check Console for this

        // 1. Remove blue color from all rows
        document.querySelectorAll('#tableInHouse tr').forEach(r => r.classList.remove('selected-row'));

        // 2. Add blue color to clicked row
        row.classList.add('selected-row');

        // 3. Enable button
        selectedInHouseId = id;
        document.getElementById('btnCheckOut').disabled = false;

        // 4. Deselect the other table
        resetLeftSide();
    }

    // --- BUTTON ACTIONS ---
    function doCheckIn() {
        if (selectedArrivalId) {
            document.getElementById('valCheckInId').value = selectedArrivalId;
            document.getElementById('formCheckIn').submit();
        }
    }

    function doCheckOut() {
        if (selectedInHouseId) {
            // REDIRECT to the Preview Page
            window.location.href = '/FrontDesk/CheckoutPreview?id=' + selectedInHouseId;
        }
    }

    // --- RESET HELPERS ---
    function resetLeftSide() {
        document.querySelectorAll('#tableArrivals tr').forEach(r => r.classList.remove('selected-row'));
        selectedArrivalId = null;
        document.getElementById('btnCheckIn').disabled = true;
    }

    function resetRightSide() {
        document.querySelectorAll('#tableInHouse tr').forEach(r => r.classList.remove('selected-row'));
        selectedInHouseId = null;
        document.getElementById('btnCheckOut').disabled = true;
    }
</script>